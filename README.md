# UmiTerm 🌊
水色テーマのRust製GPU加速ターミナルエミュレータ
<img width="914" height="268" alt="image" src="https://github.com/user-attachments/assets/613fee04-cfa5-432b-aeda-9011585f1d9c" />

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                          UmiTerm                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────┐      ┌─────────────┐      ┌─────────────────┐    │
│   │  winit  │─────▶│    main.rs  │─────▶│   Renderer      │    │
│   │ (Window)│      │  (イベント) │      │   (GPU描画)     │    │
│   └─────────┘      └──────┬──────┘      └────────┬────────┘    │
│                           │                      │              │
│                           ▼                      ▼              │
│   ┌─────────┐      ┌─────────────┐      ┌─────────────────┐    │
│   │   PTY   │◀────▶│  Terminal   │◀────▶│      Grid       │    │
│   │ (シェル)│      │   (状態)    │      │   (バッファ)    │    │
│   └─────────┘      └──────┬──────┘      └─────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│                    ┌─────────────┐                              │
│                    │   Parser    │                              │
│                    │  (ANSI解析) │                              │
│                    └─────────────┘                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## データフロー

```
キーボード入力                              画面表示
     │                                         ▲
     ▼                                         │
┌─────────┐    ┌─────┐    ┌──────────┐    ┌─────────┐
│  winit  │───▶│ PTY │───▶│ Terminal │───▶│Renderer │
│         │    │     │◀───│          │    │  (GPU)  │
└─────────┘    └─────┘    └──────────┘    └─────────┘
                  │              ▲
                  │              │
                  ▼              │
             ┌─────────┐   ┌─────────┐
             │  Shell  │   │ Parser  │
             │(bash等) │   │ (ANSI)  │
             └─────────┘   └─────────┘
```

## 各モジュールの役割

### `main.rs` - エントリーポイント
- winitでウィンドウ作成
- イベントループ（キー入力、リサイズ等）
- 各モジュールの統合

### `pty.rs` - 擬似端末
- シェル（bash/zsh）との通信
- 別スレッドでノンブロッキングI/O
- crossbeam-channelで高速なデータ転送

### `terminal.rs` - ターミナル状態
- カーソル位置
- スクロール領域
- 現在の文字スタイル（色、太字等）
- 代替スクリーン（vim等で使用）

### `grid.rs` - 文字バッファ
- 2次元配列でセルを管理
- 各セル = 文字 + 前景色 + 背景色 + フラグ
- ダーティフラグで差分更新

### `parser.rs` - ANSIパーサー
- vteクレートで高速パース
- CSI（カーソル移動、色変更等）
- OSC（タイトル変更等）
- SGR（文字装飾）

### `renderer.rs` - GPUレンダラー
- wgpuでMetal/Vulkan対応
- インスタンスレンダリング（1回の描画で全セル）
- グリフキャッシュ（フォントは1回だけラスタライズ）

### `shader.wgsl` - シェーダー
- 背景描画（単色クワッド）
- テキスト描画（グリフテクスチャ）

## ビルド・実行

```bash
# 開発版
cargo run

# リリース版（最適化済み）
cargo run --release

# カスタムフォント
UMITERM_FONT=/path/to/font.ttf cargo run --release
```

## 依存クレート

| クレート | 用途 |
|---------|------|
| wgpu | GPU描画 |
| winit | ウィンドウ管理 |
| portable-pty | 擬似端末 |
| vte | ANSIパーサー |
| fontdue | フォントラスタライズ |
| crossbeam-channel | スレッド間通信 |
| parking_lot | 高速ロック |

## 対応機能

- [x] 基本的な文字表示
- [x] 256色/TrueColor
- [x] カーソル移動・形状変更
- [x] スクロール
- [x] 代替スクリーン（vim対応）
- [x] 太字/斜体/下線
- [ ] マウス対応
- [ ] 選択・コピペ
- [ ] リガチャ
- [ ] Sixel画像
